<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>كاسحة الألغام - النسخة المطورة</title>
  <style>
    :root{
      --cell-size-desktop: 36px;
      --cell-size-mobile: 44px;
      --gap: 4px;

      --bg: #0f1724;
      --panel: linear-gradient(180deg,#0b1220,#0f2436);
      --card: rgba(255,255,255,0.03);
      --accent-1: #7dd3fc;
      --accent-2: #60a5fa;
      --accent-3: #a78bfa;
      --flag: #fb7185;
      --mine: #ef4444;
      --text: #e6eef6;
    }
    *{box-sizing:border-box;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);}
    .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;padding:18px}
    header{width:100%;max-width:980px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent-1),var(--accent-3));display:flex;align-items:center;justify-content:center;font-weight:700}
    h1{font-size:18px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    .panel{width:100%;max-width:980px;background:var(--panel);padding:12px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    .meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .meta .info{background:var(--card);padding:6px 10px;border-radius:8px;font-size:13px}
    .game-area{display:flex;gap:12px}
    .board-wrap{background:rgba(255,255,255,0.02);padding:8px;border-radius:10px;overflow:hidden}
    .board{display:grid;grid-gap:var(--gap);background:transparent;padding:6px;justify-content:center}

    /* الخلايا: width/height سيتم ضبطهم بالـ JS لتناسب الشاشة */
    .cell{display:grid;place-items:center;border-radius:6px;
      background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));color:var(--text);font-weight:700;user-select:none;cursor:pointer;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.25);transition:transform .06s ease, background .12s ease;font-size:14px}
    .cell:active{transform:translateY(1px)}
    .cell.open{background:linear-gradient(180deg,#e6eef6, #d7e8fa);color:#0b1220;font-weight:800}
    .cell.flag{background:linear-gradient(180deg,#ffecf0,#ffe7ee);color:var(--flag)}
    .cell.mine{background:linear-gradient(180deg,#ffe7e7,#ffdede);color:var(--mine)}
    .cell.hit{outline:3px solid rgba(239,68,68,0.15)}
    .n1{color:#2563eb} .n2{color:#16a34a} .n3{color:#ef4444}
    .n4{color:#7c3aed} .n5{color:#b45309} .n6{color:#0f766e}
    .toolbar{display:flex;gap:8px;align-items:center}
    .btn{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;color:var(--text);cursor:pointer}
    .btn[disabled]{opacity:0.45;cursor:not-allowed}
    .footer{margin-top:10px;font-size:13px;color:rgba(230,238,246,0.8)}

    @media (max-width:820px){.game-area{flex-direction:column;align-items:center}header{flex-direction:column;align-items:flex-start;gap:8px}}
    @media (max-width:520px){.logo{width:40px;height:40px}h1{font-size:16px}}
    .hint{font-size:13px;color:rgba(230,238,246,0.85)}
    .overlay{position:fixed;left:0;top:0;right:0;bottom:0;display:none;align-items:center;justify-content:center}
    .overlay.show{display:flex}
    .dialog{background:linear-gradient(180deg,#0b1220,#122434);padding:18px;border-radius:12px;box-shadow:0 20px 60px rgba(2,6,23,0.7);text-align:center}
    .dialog h2{margin:0 0 10px 0}.small{font-size:13px;color:rgba(230,238,246,0.8)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">K</div>
        <div>
          <h1>كاسحة الألغام - المطورة</h1>
          <div class="hint">شبكة متكيفة للموبايل والكمبيوتر — المربعات متقاربة ومظهر عصري</div>
        </div>
      </div>

      <div class="controls">
        <div class="toolbar">
          <select id="preset" class="btn">
            <option value="easy">سهل - 9x9 - 10 ألغام</option>
            <option value="normal">عادي - 16x16 - 40 ألغام</option>
            <option value="hard">صعب - 24x16 - 99 ألغام</option>
            <option value="auto">تلقائي حسب الجهاز</option>
          </select>
          <button id="newBtn" class="btn">إعادة تشغيل</button>
          <button id="muteBtn" class="btn">صوت: تشغيل</button>
          <button id="hintBtn" class="btn" disabled>تلميح (30s)</button>
        </div>
      </div>
    </header>

    <main class="panel">
      <div class="meta">
        <div class="info">الوقت: <span id="timer">0</span> ث</div>
        <div class="info">الألغام المتبقية: <span id="flagsLeft">0</span></div>
        <div class="info">محاولات: <span id="tries">0</span></div>
      </div>

      <div class="game-area">
        <div class="board-wrap">
          <div id="board" class="board"></div>
        </div>
        <div style="min-width:200px;padding-left:12px;display:flex;flex-direction:column;gap:8px;align-items:flex-start">
          <div class="info" style="padding:8px;border-radius:8px;">تعليمات: اضغط للكشف، اضغط مطولًا للفلاجز على الموبايل.</div>
          <div class="info">نصيحة: لو تطور تطبيق، استخدم الـ `WebView` أو Cordova لعمل APK سريع.</div>
        </div>
      </div>

      <div class="footer">ممكن تعديل الألوان وحجم الخلايا في ملف style.css — كما أضفت زر التلميح وصوتيات الفوز/الخسارة.</div>
    </main>
  </div>

  <div id="overlay" class="overlay">
    <div class="dialog">
      <h2 id="resultTitle">انتهت اللعبة</h2>
      <div class="small" id="resultText"></div>
      <div style="margin-top:12px"><button id="restart2" class="btn">حسناً - أعد المحاولة</button></div>
    </div>
  </div>

  <!-- أصوات -->
  <audio id="explosionSound" preload="auto" src="https://www.soundjay.com/button/sounds/beep-07.mp3"></audio>
  <audio id="correctSound" preload="auto" src="https://www.soundjay.com/button/sounds/beep-06.mp3"></audio>
  <audio id="winSound" preload="auto" src="https://www.soundjay.com/misc/sounds/bell-ringing-01.mp3"></audio>
  <audio id="loseSound" preload="auto" src="https://www.soundjay.com/misc/sounds/fail-trombone-01.mp3"></audio>

  <script>
    // عناصر DOM
    const boardEl = document.getElementById('board');
    const timerEl = document.getElementById('timer');
    const flagsLeftEl = document.getElementById('flagsLeft');
    const presetEl = document.getElementById('preset');
    const newBtn = document.getElementById('newBtn');
    const overlay = document.getElementById('overlay');
    const resultTitle = document.getElementById('resultTitle');
    const resultText = document.getElementById('resultText');
    const restart2 = document.getElementById('restart2');
    const triesEl = document.getElementById('tries');
    const muteBtn = document.getElementById('muteBtn');
    const hintBtn = document.getElementById('hintBtn');

    const explosionSound = document.getElementById('explosionSound');
    const correctSound = document.getElementById('correctSound');
    const winSound = document.getElementById('winSound');
    const loseSound = document.getElementById('loseSound');

    // حالة وصلاحيات
    let gridWidth = 9, gridHeight = 9, minesCount = 10;
    let grid = [];
    let opened = 0, flags = 0, timer=0, timerInterval=null, tries=0;
    let started = false; // مهم: نستخدمه لنعرف أول نقرة
    let soundEnabled = true;
    let isMobile = ('ontouchstart' in window) || navigator.maxTouchPoints>0;

    // تلميح
    let hintCooldown = 30; // ثواني
    let lastHint = 0; // timestamp
    let hintTimerInterval = null;

    function decideAuto(){
      const w = Math.max(window.innerWidth, document.documentElement.clientWidth);
      if (w < 520){ gridWidth = 9; gridHeight = 12; minesCount = 12; }
      else if (w < 900){ gridWidth = 12; gridHeight = 16; minesCount = 30; }
      else { gridWidth = 16; gridHeight = 16; minesCount = 40; }
    }

    function applyPreset(preset){
      if (preset === 'easy'){ gridWidth=9; gridHeight=9; minesCount=10; }
      else if (preset === 'normal'){ gridWidth=16; gridHeight=16; minesCount=40; }
      else if (preset === 'hard'){ gridWidth=24; gridHeight=16; minesCount=99; }
      else if (preset === 'auto'){ decideAuto(); }
    }

    function createEmptyGrid(w,h){
      const arr = [];
      for(let y=0;y<h;y++){
        const row = [];
        for(let x=0;x<w;x++){
          row.push({x,y, mine:false, open:false, flag:false, num:0, el:null});
        }
        arr.push(row);
      }
      return arr;
    }

    function placeMines(firstX, firstY){
      let placed=0;
      while(placed < minesCount){
        const rx = Math.floor(Math.random()*gridWidth);
        const ry = Math.floor(Math.random()*gridHeight);
        const cell = grid[ry][rx];
        if (cell.mine) continue;
        if (Math.abs(rx-firstX)<=1 && Math.abs(ry-firstY)<=1) continue;
        cell.mine = true; placed++;
      }
      for(let y=0;y<gridHeight;y++){
        for(let x=0;x<gridWidth;x++){
          const c = grid[y][x];
          if (c.mine) continue;
          let count=0;
          for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
            const nx=x+dx, ny=y+dy;
            if (nx<0||ny<0||nx>=gridWidth||ny>=gridHeight) continue;
            if (grid[ny][nx].mine) count++;
          }
          c.num = count;
        }
      }
    }

    function computeCellSize(){
      // نحسب عرض متاح وناخد حجم خلية مناسب عشان الخلايا ما تخرجش برة الشاشة
      const padding = 36; // بعض الحواف
      const gapTotal = (gridWidth - 1) * 4; // استخدام --gap التقريبي
      const maxWidth = Math.min(window.innerWidth - padding, 980);
      const preferred = isMobile ? parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell-size-mobile')) : parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell-size-desktop'));
      const cell = Math.floor(Math.min(preferred, (maxWidth - gapTotal) / gridWidth));
      return Math.max(28, cell); // لا تصغر عن 28px عشان لسه مريح
    }

    function resetBoard(){
      // إعادة الحالة
      started = false; opened=0; flags=0; clearInterval(timerInterval); timer=0; timerEl.textContent='0';
      boardEl.innerHTML=''; overlay.classList.remove('show');
      applyPreset(presetEl.value);
      grid = createEmptyGrid(gridWidth, gridHeight);

      // ضبط حجم الخلايا ديناميكياً
      const cellSize = computeCellSize();
      boardEl.style.gridTemplateColumns = `repeat(${gridWidth}, ${cellSize}px)`;

      flagsLeftEl.textContent = minesCount;
      triesEl.textContent = tries;

      // إنشاء عناصر الخلايا
      for(let y=0;y<gridHeight;y++){
        for(let x=0;x<gridWidth;x++){
          const c = grid[y][x];
          const el = document.createElement('div');
          el.className='cell';
          el.style.width = cellSize + 'px';
          el.style.height = cellSize + 'px';
          el.dataset.x=x; el.dataset.y=y;
          c.el = el;

          el.addEventListener('click', (e)=>{ onCellClick(e, x, y); });
          el.addEventListener('contextmenu', (e)=>{ e.preventDefault(); toggleFlag(x,y); });

          if (isMobile){
            // Long-press صارم: نريد أن تضغط مطولاً لتضع العلم، وإذا ضغطت مطولاً مرة تانية تزيله.
            let pressTimer=null; let pressed=false;
            const start = (ev)=>{ ev.preventDefault(); pressed=false; pressTimer = setTimeout(()=>{ toggleFlag(x,y); pressed=true; }, 500); };
            const end = (ev)=>{ if (pressTimer) { clearTimeout(pressTimer); pressTimer=null; } };
            el.addEventListener('touchstart', start, {passive:false});
            el.addEventListener('touchend', end);
            el.addEventListener('touchmove', end);
            el.addEventListener('touchcancel', end);
          }

          boardEl.appendChild(el);
        }
      }

      // إعادة تفعيل زر التلميح بعد التهيئة
      startHintTimer();
    }

    function onCellClick(e,x,y){
      const cell = grid[y][x];
      if (!started){ placeMines(x,y); startTimer(); started = true; }
      if (cell.open || cell.flag) return;

      if (cell.mine){
        // نلعب صوت الانفجار + صوت الخسارة
        if (soundEnabled){ explosionSound.currentTime = 0; explosionSound.play().catch(()=>{}); loseSound.currentTime = 0; loseSound.play().catch(()=>{}); }
        revealAll(false,x,y);
        return;
      }

      // صوت خفيف للخلية الصحيحة
      if (soundEnabled){ correctSound.currentTime = 0; correctSound.play().catch(()=>{}); }

      floodOpen(x,y);
      updateState();
      checkWin();
    }

    function floodOpen(sx,sy){
      const stack = [[sx,sy]];
      while(stack.length){
        const [x,y] = stack.pop();
        const c = grid[y][x];
        if (c.open || c.flag) continue;
        c.open = true; opened++;
        c.el.classList.add('open');
        if (c.num>0){ c.el.textContent = c.num; c.el.classList.add('n'+c.num); }
        if (c.num===0){
          for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
            const nx=x+dx, ny=y+dy;
            if (nx<0||ny<0||nx>=gridWidth||ny>=gridHeight) continue;
            if (!grid[ny][nx].open && !grid[ny][nx].mine) stack.push([nx,ny]);
          }
        }
      }
    }

    function toggleFlag(x,y){
      const c = grid[y][x];
      if (c.open) return;
      c.flag = !c.flag;
      if (c.flag){ c.el.classList.add('flag'); flags++; c.el.textContent='⚑'; }
      else{ c.el.classList.remove('flag'); flags--; c.el.textContent=''; }
      flagsLeftEl.textContent = Math.max(0, minesCount - flags);
    }

    function revealAll(win, hitX, hitY){
      clearInterval(timerInterval);
      // نكشف الألغام ونظهر النتائج
      for(let y=0;y<gridHeight;y++) for(let x=0;x<gridWidth;x++){
        const c = grid[y][x];
        if (c.mine){ c.el.classList.add('mine'); c.el.textContent = '💣'; }
        if (c.flag && !c.mine){ c.el.textContent='✖'; }
      }
      if (hitX !== undefined && hitX !== null){ grid[hitY][hitX].el.classList.add('hit'); }

      tries++;
      triesEl.textContent = tries;

      if (win){ if (soundEnabled){ winSound.currentTime = 0; winSound.play().catch(()=>{}); } showResult(true); }
      else{ showResult(false); }
    }

    function checkWin(){
      const total = gridWidth*gridHeight;
      if (opened === total - minesCount){ revealAll(true); }
    }

    function showResult(win){
      if (!win){ resultTitle.textContent='خسرت!'; resultText.textContent = 'لقد نفجر لغم... حاول مرة أخرى.'; }
      else{ resultTitle.textContent='مبروك!'; resultText.textContent = `فزت في ${timer} ثانية — محاولات: ${tries}`; }
      overlay.classList.add('show');
    }

    function startTimer(){ timerInterval = setInterval(()=>{ timer++; timerEl.textContent = timer; }, 1000); }
    function updateState(){ flagsLeftEl.textContent = Math.max(0, minesCount - flags); }

    // --- تلميح ---
    function startHintTimer(){
      // إعادة ضبط
      if (hintTimerInterval) clearInterval(hintTimerInterval);
      lastHint = Date.now() - hintCooldown*1000; // متاح فوراً بعد إعادة تشغيل اللعبة
      updateHintButton();
      hintTimerInterval = setInterval(updateHintButton, 500);
    }

    function updateHintButton(){
      const elapsed = (Date.now() - lastHint) / 1000;
      const remain = Math.max(0, Math.ceil(hintCooldown - elapsed));
      if (remain === 0){ hintBtn.disabled = false; hintBtn.textContent = 'تلميح'; }
      else { hintBtn.disabled = true; hintBtn.textContent = `تلميح (${remain}s)`; }
    }

    function giveHint(){
      // نجد خلية آمنة غير مكشوفة وعشوائية
      const safe = [];
      for(let y=0;y<gridHeight;y++) for(let x=0;x<gridWidth;x++){
        const c = grid[y][x];
        if (!c.open && !c.mine && !c.flag) safe.push(c);
      }
      if (safe.length===0) return;
      const pick = safe[Math.floor(Math.random()*safe.length)];
      // نكشفها
      if (!started){ placeMines(pick.x,pick.y); startTimer(); started = true; }
      floodOpen(pick.x, pick.y);
      lastHint = Date.now();
      updateHintButton();
    }

    // أحداث الأزرار
    newBtn.addEventListener('click', ()=>{ resetBoard(); });
    restart2.addEventListener('click', ()=>{ resetBoard(); overlay.classList.remove('show'); });
    presetEl.addEventListener('change', ()=>{ resetBoard(); });
    window.addEventListener('resize', ()=>{ if (presetEl.value==='auto') resetBoard(); });
    muteBtn.addEventListener('click', ()=>{ soundEnabled = !soundEnabled; muteBtn.textContent = soundEnabled ? 'صوت: تشغيل' : 'صوت: إيقاف'; });
    hintBtn.addEventListener('click', ()=>{ if (!hintBtn.disabled) giveHint(); });

    // تشغيل أولي
    (function init(){ applyPreset(presetEl.value); resetBoard(); })();

    // ملاحظات:
    // • إذا لم تسمع الأصوات تأكد إنك تفاعلت مع الصفحة (نقرة) لأن المتصفحات تمنع التشغيل التلقائي للأصوات.
    // • لو عايز أضع الملفات صوت محلي (ضمن المشروع) أقدر أرفع لك ملفات .mp3 وأعدل الـ src لتكون ملفات محلية.

  </script>
</body>
</html>
