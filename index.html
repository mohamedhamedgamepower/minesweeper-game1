<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÙƒØ§Ø³Ø­Ø© Ø§Ù„Ø£Ù„ØºØ§Ù… â€“ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙˆÙ„ÙˆØ­Ø© Ù…ØªØµØ¯Ø±ÙŠÙ†</title>
  <style>
    :root{
      --cell-size-desktop: 36px;
      --cell-size-mobile: 44px;
      --gap: 4px;
      --bg: #0f1724; --panel: linear-gradient(180deg,#0b1220,#0f2436);
      --card: rgba(255,255,255,0.06);
      --accent-1: #7dd3fc; --accent-2: #60a5fa; --accent-3: #a78bfa;
      --flag: #fb7185; --mine: #ef4444; --text: #e6eef6;
    }
    *{box-sizing:border-box;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text)}
    .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;padding:18px;gap:12px}
    header{width:100%;max-width:1100px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent-1),var(--accent-3));display:flex;align-items:center;justify-content:center;font-weight:700}
    h1{font-size:18px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}

    .panel{width:100%;max-width:1100px;background:var(--panel);padding:12px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    .meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .meta .info{background:var(--card);padding:6px 10px;border-radius:8px;font-size:13px}

    .game-area{display:grid;grid-template-columns: 1fr 280px;gap:12px}
    .board-wrap{background:rgba(255,255,255,0.03);padding:8px;border-radius:10px;overflow:hidden}
    .board{display:grid;grid-gap:var(--gap);background:transparent;padding:6px;justify-content:center}

    /* Ø§Ù„Ø®Ù„Ø§ÙŠØ§ */
    .cell{display:grid;place-items:center;border-radius:6px;
      background:linear-gradient(180deg,rgba(255,255,255,0.05),rgba(255,255,255,0.02));color:var(--text);font-weight:700;user-select:none;cursor:pointer;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.25);transition:transform .06s ease, background .12s ease;font-size:14px}
    .cell:active{transform:translateY(1px)}
    .cell.open{background:linear-gradient(180deg,#e6eef6, #d7e8fa);color:#0b1220;font-weight:800}
    .cell.flag{background:linear-gradient(180deg,#ffecf0,#ffe7ee);color:var(--flag)}
    .cell.mine{background:linear-gradient(180deg,#ffe7e7,#ffdede);color:var(--mine)}
    .cell.hit{outline:3px solid rgba(239,68,68,0.15)}
    .n1{color:#2563eb} .n2{color:#16a34a} .n3{color:#ef4444}
    .n4{color:#7c3aed} .n5{color:#b45309} .n6{color:#0f766e}

    .toolbar{display:flex;gap:8px;align-items:center}
    .btn{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;color:var(--text);cursor:pointer}
    .btn[disabled]{opacity:0.45;cursor:not-allowed}

    /* Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† */
    .sidebar{background:rgba(255,255,255,0.03);padding:10px;border-radius:10px;display:flex;flex-direction:column;gap:8px}
    .side-title{display:flex;align-items:center;justify-content:space-between}
    .leader-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px}
    .leader-item{display:flex;justify-content:space-between;gap:8px;background:rgba(255,255,255,0.04);padding:8px;border-radius:8px}

    /* Ù„ÙˆØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    .auth{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,0.04);padding:8px;border-radius:10px}
    .auth input{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08);color:var(--text);border-radius:8px;padding:6px 8px}

    .footer{margin-top:10px;font-size:13px;color:rgba(230,238,246,0.8)}

    @media (max-width:900px){
      .game-area{grid-template-columns: 1fr}
      .sidebar{order:-1}
    }

    .hint{font-size:13px;color:rgba(230,238,246,0.85)}
    .overlay{position:fixed;left:0;top:0;right:0;bottom:0;display:none;align-items:center;justify-content:center}
    .overlay.show{display:flex}
    .dialog{background:linear-gradient(180deg,#0b1220,#122434);padding:18px;border-radius:12px;box-shadow:0 20px 60px rgba(2,6,23,0.7);text-align:center}
    .dialog h2{margin:0 0 10px 0}.small{font-size:13px;color:rgba(230,238,246,0.8)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">K</div>
        <div>
          <h1>ÙƒØ§Ø³Ø­Ø© Ø§Ù„Ø£Ù„ØºØ§Ù… â€“ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</h1>
          <div class="hint">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ + Ù†Ù‚Ø§Ø· + Ù„ÙˆØ­Ø© Ù…ØªØµØ¯Ø±ÙŠÙ† (Top 10)</div>
        </div>
      </div>

      <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„Ø­Ø³Ø§Ø¨ -->
      <div class="auth" id="authBox">
        <div id="whenSignedOut">
          <button class="btn" id="googleBtn">ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¬ÙˆØ¬Ù„</button>
          <input id="email" type="email" placeholder="Ø¥ÙŠÙ…ÙŠÙ„" />
          <input id="pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" />
          <button class="btn" id="emailSignUp">ØªØ³Ø¬ÙŠÙ„</button>
          <button class="btn" id="emailSignIn">Ø¯Ø®ÙˆÙ„</button>
        </div>
        <div id="whenSignedIn" style="display:none;gap:8px;align-items:center">
          <span>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <b id="dispName">Ù„Ø§Ø¹Ø¨</b> â€” Ù†Ù‚Ø§Ø·Ùƒ: <b id="myPoints">0</b></span>
          <input id="usernameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="width:140px" />
          <button class="btn" id="saveUsername">Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…</button>
          <button class="btn" id="signOutBtn">Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>
    </header>

    <main class="panel">
      <div class="meta">
        <div class="info">Ø§Ù„ÙˆÙ‚Øª: <span id="timer">0</span> Ø«</div>
        <div class="info">Ø§Ù„Ø£Ù„ØºØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: <span id="flagsLeft">0</span></div>
        <div class="info">Ù…Ø­Ø§ÙˆÙ„Ø§Øª: <span id="tries">0</span></div>
        <div class="toolbar">
          <select id="preset" class="btn">
            <option value="easy">Ø³Ù‡Ù„ - 9x9 - 10 Ø£Ù„ØºØ§Ù… (10 Ù†Ù‚Ø§Ø·)</option>
            <option value="normal">Ø¹Ø§Ø¯ÙŠ - 16x16 - 40 Ø£Ù„ØºØ§Ù… (40 Ù†Ù‚Ø·Ø©)</option>
            <option value="hard">ØµØ¹Ø¨ - 24x16 - 99 Ø£Ù„ØºØ§Ù… (99 Ù†Ù‚Ø·Ø©)</option>
            <option value="auto">ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù‡Ø§Ø²</option>
          </select>
          <button id="newBtn" class="btn">Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„</button>
          <button id="muteBtn" class="btn">ØµÙˆØª: ØªØ´ØºÙŠÙ„</button>
          <button id="hintBtn" class="btn" disabled>ØªÙ„Ù…ÙŠØ­ (30s)</button>
          <button id="toggleLeaders" class="btn">ğŸ† Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</button>
        </div>
      </div>

      <div class="game-area">
        <div class="board-wrap">
          <div id="board" class="board"></div>
        </div>

        <aside class="sidebar" id="leadersBox" style="display:none">
          <div class="side-title">
            <strong>Ø£ÙØ¶Ù„ 10 Ù„Ø§Ø¹Ø¨ÙŠÙ†</strong>
            <span id="lastUpdate" class="hint"></span>
          </div>
          <ul id="leaders" class="leader-list"></ul>
        </aside>
      </div>

      <div class="footer">Ø§Ù„Ù†Ù‚Ø§Ø· ØªÙØ­ØªØ³Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØºØ´. ØªØ­ØªØ§Ø¬ Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ø§Ù†Ø¸Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø©).</div>
    </main>
  </div>

  <div id="overlay" class="overlay">
    <div class="dialog">
      <h2 id="resultTitle">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
      <div class="small" id="resultText"></div>
      <div style="margin-top:12px"><button id="restart2" class="btn">Ø­Ø³Ù†Ø§Ù‹ - Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button></div>
    </div>
  </div>

  <!-- Ø£ØµÙˆØ§Øª -->
  <audio id="explosionSound" preload="auto" src="https://www.soundjay.com/button/sounds/beep-07.mp3"></audio>
  <audio id="correctSound" preload="auto" src="https://www.soundjay.com/button/sounds/beep-06.mp3"></audio>
  <audio id="winSound" preload="auto" src="https://www.soundjay.com/misc/sounds/bell-ringing-01.mp3"></audio>
  <audio id="loseSound" preload="auto" src="https://www.soundjay.com/misc/sounds/fail-trombone-01.mp3"></audio>

  <!-- Firebase SDK (Compat Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ø¯Ù…Ø¬ ÙÙŠ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

  <script>
    /******************** Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ********************/
    // 1) Ø£Ù†Ø´Ø¦ Ù…Ø´Ø±ÙˆØ¹ Ø¹Ù„Ù‰ Firebase Ø«Ù… ÙØ¹Ù‘Ù„ Authentication (Google + Email/Password) Ùˆ Firestore Ùˆ Functions
    // 2) Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ø£Ø®Ø°ØªÙ‡Ø§ Ù…Ù† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø°ÙŠ Ø²ÙˆÙ‘Ø¯ØªÙ†ÙŠ Ø¨Ù‡ â€” Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª ØªØºÙŠÙ‘Ø±Ù‡Ø§ Ø¹Ø¯Ù„ Ø§Ù„Ù‚ÙŠÙ… Ù‡Ù†Ø§
    const firebaseConfig = {
      apiKey: "AIzaSyBGqFj5J8x6O2Y5NjOSxh6_ZgBDp1VqQac",
      authDomain: "minesweepergame-29187.firebaseapp.com",
      projectId: "minesweepergame-29187",
      storageBucket: "minesweepergame-29187.firebasestorage.app",
      messagingSenderId: "1039265745118",
      appId: "1:1039265745118:web:be80c215117825ee395a4f",
      measurementId: "G-KTV9CS2P42"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.functions();

    // callable function (Ø³Ù†Ø¬Ø±Ø¨ secureRecordWin Ø«Ù… awardWin ÙƒØ¨Ø¯Ø§Ø¦Ù„)
    let awardWinCallable = null;
    try { awardWinCallable = functions.httpsCallable('secureRecordWin'); } catch(e) {
      try { awardWinCallable = functions.httpsCallable('awardWin'); } catch(e2) { awardWinCallable = null; }
    }

    /******************** Ø¹Ù†Ø§ØµØ± DOM Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù„Ø¹Ø¨Ø© ********************/
    const boardEl = document.getElementById('board');
    const timerEl = document.getElementById('timer');
    const flagsLeftEl = document.getElementById('flagsLeft');
    const presetEl = document.getElementById('preset');
    const newBtn = document.getElementById('newBtn');
    const overlay = document.getElementById('overlay');
    const resultTitle = document.getElementById('resultTitle');
    const resultText = document.getElementById('resultText');
    const restart2 = document.getElementById('restart2');
    const triesEl = document.getElementById('tries');
    const muteBtn = document.getElementById('muteBtn');
    const hintBtn = document.getElementById('hintBtn');

    const explosionSound = document.getElementById('explosionSound');
    const correctSound = document.getElementById('correctSound');
    const winSound = document.getElementById('winSound');
    const loseSound = document.getElementById('loseSound');

    // Auth UI
    const whenSignedOut = document.getElementById('whenSignedOut');
    const whenSignedIn = document.getElementById('whenSignedIn');
    const googleBtn = document.getElementById('googleBtn');
    const emailSignUp = document.getElementById('emailSignUp');
    const emailSignIn = document.getElementById('emailSignIn');
    const emailInput = document.getElementById('email');
    const passInput = document.getElementById('pass');
    const signOutBtn = document.getElementById('signOutBtn');
    const dispName = document.getElementById('dispName');
    const myPointsEl = document.getElementById('myPoints');
    const usernameInput = document.getElementById('usernameInput');
    const saveUsernameBtn = document.getElementById('saveUsername');

    // Leaders
    const leadersBox = document.getElementById('leadersBox');
    const toggleLeaders = document.getElementById('toggleLeaders');
    const leadersEl = document.getElementById('leaders');
    const lastUpdateEl = document.getElementById('lastUpdate');

    // Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
    let gridWidth = 9, gridHeight = 9, minesCount = 10;
    let grid = [];
    let opened = 0, flags = 0, timer=0, timerInterval=null, tries=0;
    let started = false; // Ø£ÙˆÙ„ Ù†Ù‚Ø±Ø©
    let soundEnabled = true;
    let isMobile = ('ontouchstart' in window) || navigator.maxTouchPoints>0;

    // ØªÙ„Ù…ÙŠØ­
    let hintCooldown = 30; // Ø«ÙˆØ§Ù†ÙŠ
    let lastHint = 0; // timestamp
    let hintTimerInterval = null;

    // Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
    const levelPoints = { easy:10, normal:40, hard:99 };

    function decideAuto(){
      const w = Math.max(window.innerWidth, document.documentElement.clientWidth);
      if (w < 520){ gridWidth = 9; gridHeight = 12; minesCount = 12; }
      else if (w < 900){ gridWidth = 12; gridHeight = 16; minesCount = 30; }
      else { gridWidth = 16; gridHeight = 16; minesCount = 40; }
    }

    function applyPreset(preset){
      if (preset === 'easy'){ gridWidth=9; gridHeight=9; minesCount=10; }
      else if (preset === 'normal'){ gridWidth=16; gridHeight=16; minesCount=40; }
      else if (preset === 'hard'){ gridWidth=24; gridHeight=16; minesCount=99; }
      else if (preset === 'auto'){ decideAuto(); }
    }

    function createEmptyGrid(w,h){
      const arr = [];
      for(let y=0;y<h;y++){
        const row = [];
        for(let x=0;x<w;x++){
          row.push({x,y, mine:false, open:false, flag:false, num:0, el:null});
        }
        arr.push(row);
      }
      return arr;
    }

    function placeMines(firstX, firstY){
      let placed=0;
      while(placed < minesCount){
        const rx = Math.floor(Math.random()*gridWidth);
        const ry = Math.floor(Math.random()*gridHeight);
        const cell = grid[ry][rx];
        if (cell.mine) continue;
        if (Math.abs(rx-firstX)<=1 && Math.abs(ry-firstY)<=1) continue; // Ø­Ù…Ø§ÙŠØ© Ø£ÙˆÙ„ Ù†Ù‚Ø±Ø©
        cell.mine = true; placed++;
      }
      for(let y=0;y<gridHeight;y++){
        for(let x=0;x<gridWidth;x++){
          const c = grid[y][x];
          if (c.mine) continue;
          let count=0;
          for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
            const nx=x+dx, ny=y+dy;
            if (nx<0||ny<0||nx>=gridWidth||ny>=gridHeight) continue;
            if (grid[ny][nx].mine) count++;
          }
          c.num = count;
        }
      }
    }

    function computeCellSize(){
      const padding = 36;
      const gapTotal = (gridWidth - 1) * 4;
      const maxWidth = Math.min(window.innerWidth - padding, 980);
      const preferred = isMobile ? parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell-size-mobile')) : parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell-size-desktop'));
      const cell = Math.floor(Math.min(preferred, (maxWidth - gapTotal) / gridWidth));
      return Math.max(28, cell);
    }

    function resetBoard(){
      started = false; opened=0; flags=0; clearInterval(timerInterval); timer=0; timerEl.textContent='0';
      boardEl.innerHTML=''; overlay.classList.remove('show');
      applyPreset(presetEl.value);
      grid = createEmptyGrid(gridWidth, gridHeight);

      const cellSize = computeCellSize();
      boardEl.style.gridTemplateColumns = `repeat(${gridWidth}, ${cellSize}px)`;

      flagsLeftEl.textContent = minesCount;
      triesEl.textContent = tries;

      for(let y=0;y<gridHeight;y++){
        for(let x=0;x<gridWidth;x++){
          const c = grid[y][x];
          const el = document.createElement('div');
          el.className='cell';
          el.style.width = cellSize + 'px';
          el.style.height = cellSize + 'px';
          el.dataset.x=x; el.dataset.y=y;
          c.el = el;

          el.addEventListener('click', (e)=>{ onCellClick(e, x, y); });
          el.addEventListener('contextmenu', (e)=>{ e.preventDefault(); toggleFlag(x,y); });

          if (isMobile){
            let pressTimer=null;
            const start = (ev)=>{ ev.preventDefault(); pressTimer = setTimeout(()=>{ toggleFlag(x,y); }, 500); };
            const end = (ev)=>{ if (pressTimer) { clearTimeout(pressTimer); pressTimer=null; } };
            el.addEventListener('touchstart', start, {passive:false});
            el.addEventListener('touchend', end);
            el.addEventListener('touchmove', end);
            el.addEventListener('touchcancel', end);
          }

          boardEl.appendChild(el);
        }
      }

      startHintTimer();
    }

    function onCellClick(e,x,y){
      const cell = grid[y][x];
      if (!started){ placeMines(x,y); startTimer(); started = true; }
      if (cell.open || cell.flag) return;

      if (cell.mine){
        if (soundEnabled){ explosionSound.currentTime = 0; explosionSound.play().catch(()=>{}); loseSound.currentTime = 0; loseSound.play().catch(()=>{}); }
        revealAll(false,x,y);
        return;
      }

      if (soundEnabled){ correctSound.currentTime = 0; correctSound.play().catch(()=>{}); }

      floodOpen(x,y);
      updateState();
      checkWin();
    }

    function floodOpen(sx,sy){
      const stack = [[sx,sy]];
      while(stack.length){
        const [x,y] = stack.pop();
        const c = grid[y][x];
        if (c.open || c.flag) continue;
        c.open = true; opened++;
        c.el.classList.add('open');
        if (c.num>0){ c.el.textContent = c.num; c.el.classList.add('n'+c.num); }
        if (c.num===0){
          for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
            const nx=x+dx, ny=y+dy;
            if (nx<0||ny<0||nx>=gridWidth||ny>=gridHeight) continue;
            if (!grid[ny][nx].open && !grid[ny][nx].mine) stack.push([nx,ny]);
          }
        }
      }
    }

    function toggleFlag(x,y){
      const c = grid[y][x];
      if (c.open) return;
      c.flag = !c.flag;
      if (c.flag){ c.el.classList.add('flag'); flags++; c.el.textContent='âš‘'; }
      else{ c.el.classList.remove('flag'); flags--; c.el.textContent=''; }
      flagsLeftEl.textContent = Math.max(0, minesCount - flags);
    }

    function revealAll(win, hitX, hitY){
      clearInterval(timerInterval);
      for(let y=0;y<gridHeight;y++) for(let x=0;x<gridWidth;x++){
        const c = grid[y][x];
        if (c.mine){ c.el.classList.add('mine'); c.el.textContent = 'ğŸ’£'; }
        if (c.flag && !c.mine){ c.el.textContent='âœ–'; }
      }
      if (hitX !== undefined && hitX !== null){ grid[hitY][hitX].el.classList.add('hit'); }

      tries++;
      triesEl.textContent = tries;

      if (win){ if (soundEnabled){ winSound.currentTime = 0; winSound.play().catch(()=>{}); } showResult(true); }
      else{ showResult(false); }
    }

    function checkWin(){
      const total = gridWidth*gridHeight;
      if (opened === total - minesCount){
        // Ø­ÙØ³Ø¨ Ø§Ù„ÙÙˆØ² â€” Ù†ÙƒØ´Ù ÙˆÙ†Ø­Ø³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·
        revealAll(true);
        awardWinSecure();
      }
    }

    function showResult(win){
      if (!win){ resultTitle.textContent='Ø®Ø³Ø±Øª!'; resultText.textContent = 'Ø§Ù†ÙØ¬Ø± Ù„ØºÙ….. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'; }
      else{ resultTitle.textContent='Ù…Ø¨Ø±ÙˆÙƒ!'; resultText.textContent = `ÙØ²Øª ÙÙŠ ${timer} Ø«Ø§Ù†ÙŠØ© â€” Ù…Ø­Ø§ÙˆÙ„Ø§Øª: ${tries}`; }
      overlay.classList.add('show');
    }

    function startTimer(){ timerInterval = setInterval(()=>{ timer++; timerEl.textContent = timer; }, 1000); }
    function updateState(){ flagsLeftEl.textContent = Math.max(0, minesCount - flags); }

    /********** Ø§Ù„ØªÙ„Ù…ÙŠØ­ **********/
    function startHintTimer(){
      if (hintTimerInterval) clearInterval(hintTimerInterval);
      lastHint = Date.now() - hintCooldown*1000; // Ù…ØªØ§Ø­ ÙÙˆØ±Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
      updateHintButton();
      hintTimerInterval = setInterval(updateHintButton, 500);
    }
    function updateHintButton(){
      const elapsed = (Date.now() - lastHint) / 1000;
      const remain = Math.max(0, Math.ceil(hintCooldown - elapsed));
      if (remain === 0){ hintBtn.disabled = false; hintBtn.textContent = 'ØªÙ„Ù…ÙŠØ­'; }
      else { hintBtn.disabled = true; hintBtn.textContent = `ØªÙ„Ù…ÙŠØ­ (${remain}s)`; }
    }
    function giveHint(){
      const safe = [];
      for(let y=0;y<gridHeight;y++) for(let x=0;x<gridWidth;x++){
        const c = grid[y][x];
        if (!c.open && !c.mine && !c.flag) safe.push(c);
      }
      if (safe.length===0) return;
      const pick = safe[Math.floor(Math.random()*safe.length)];
      if (!started){ placeMines(pick.x,pick.y); startTimer(); started = true; }
      floodOpen(pick.x,pick.y);
      lastHint = Date.now();
      updateHintButton();
    }

    /********** Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø± **********/
    newBtn.addEventListener('click', ()=>{ resetBoard(); });
    restart2.addEventListener('click', ()=>{ resetBoard(); overlay.classList.remove('show'); });
    presetEl.addEventListener('change', ()=>{ resetBoard(); });
    window.addEventListener('resize', ()=>{ if (presetEl.value==='auto') resetBoard(); });
    muteBtn.addEventListener('click', ()=>{ soundEnabled = !soundEnabled; muteBtn.textContent = soundEnabled ? 'ØµÙˆØª: ØªØ´ØºÙŠÙ„' : 'ØµÙˆØª: Ø¥ÙŠÙ‚Ø§Ù'; });
    hintBtn.addEventListener('click', ()=>{ if (!hintBtn.disabled) giveHint(); });
    document.getElementById('toggleLeaders').addEventListener('click', ()=>{
      leadersBox.style.display = leadersBox.style.display==='none' ? 'flex' : 'none';
    });

    // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
    (function init(){ applyPreset(presetEl.value); resetBoard(); })();

    /******************** Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ù†Ù‚Ø§Ø· ********************/
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¬ÙˆØ¬Ù„
    googleBtn.addEventListener('click', async ()=>{
      const provider = new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
    });

    // ØªØ³Ø¬ÙŠÙ„/Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯
    emailSignUp.addEventListener('click', async ()=>{
      if (!emailInput.value || !passInput.value) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±');
      await auth.createUserWithEmailAndPassword(emailInput.value, passInput.value);
    });
    emailSignIn.addEventListener('click', async ()=>{
      if (!emailInput.value || !passInput.value) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±');
      await auth.signInWithEmailAndPassword(emailInput.value, passInput.value);
    });
    signOutBtn.addEventListener('click', ()=> auth.signOut());

    // Ø¹Ù†Ø¯ ØªØºÙŠÙ‘Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    let userUnsub = null; // Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨
    auth.onAuthStateChanged(async (user)=>{
      if (user){
        whenSignedOut.style.display='none';
        whenSignedIn.style.display='flex';
        dispName.textContent = user.displayName || 'Ù„Ø§Ø¹Ø¨';

        // Ø§Ø¶Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙˆØ«ÙŠÙ‚Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const uref = db.collection('users').doc(user.uid);
        await db.runTransaction(async (tx)=>{
          const snap = await tx.get(uref);
          if (!snap.exists){
            tx.set(uref, {
              uid: user.uid,
              email: user.email || null,
              username: user.displayName || '',
              points: 0,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        });

        // Ø§Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠØ± Ù†Ù‚Ø§Ø·ÙŠ
        if (userUnsub) userUnsub();
        userUnsub = uref.onSnapshot((doc)=>{
          if (doc.exists){
            const d = doc.data();
            myPointsEl.textContent = d.points || 0;
            usernameInput.value = d.username || '';
          }
        });

        // Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†
        startLeadersLive();
      } else {
        whenSignedOut.style.display='flex';
        whenSignedIn.style.display='none';
        myPointsEl.textContent = '0';
        stopLeadersLive();
      }
    });

    // Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    saveUsernameBtn.addEventListener('click', async ()=>{
      const user = auth.currentUser; if (!user) return alert('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
      const name = (usernameInput.value||'').trim().slice(0,24);
      await db.collection('users').doc(user.uid).set({username: name, updatedAt: firebase.firestore.FieldValue.serverTimestamp()}, {merge:true});
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…');
    });

    // Ù…Ù†Ø­ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† Ø¹Ø¨Ø± Cloud Function
    async function awardWinSecure(){
      const user = auth.currentUser;
      if (!user){ return; } // Ù„Ø§ Ù†Ù‚Ø§Ø· Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„

      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ
      const preset = presetEl.value;
      let level = 'easy';
      if (preset==='normal') level='normal';
      else if (preset==='hard') level='hard';
      else if (preset==='auto'){ // Ø®Ø±ÙŠØ·Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ø­Ø³Ø¨ Ø­Ø¬Ù… Ø§Ù„Ø´Ø¨ÙƒØ©
        const total = gridWidth*gridHeight;
        level = total>=384 ? 'hard' : (total>=192 ? 'normal' : 'easy');
      }

      try{
        if (awardWinCallable){
          const res = await awardWinCallable({ level });
          // Ø§Ø®ØªÙŠØ§Ø±ÙŠØ§Ù‹: Ø£Ø¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
          if (res && res.data && res.data.ok){ /* ØªÙ… */ }
        } else {
          // ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ØªÙÙØ¹Ù‘Ù„ Functions Ø¨Ø¹Ø¯ØŒ ÙƒØ­Ù„ Ù…Ø¤Ù‚Øª (Ø£Ù‚Ù„ Ø£Ù…Ø§Ù†Ø§Ù‹):
          const points = levelPoints[level] || 0;
          await db.collection('users').doc(user.uid).set({
            points: firebase.firestore.FieldValue.increment(points),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, {merge:true});
        }
      }catch(err){
        console.error('awardWin failed', err);
      }
    }

    /********** Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† Top 10 **********/
    let leadersUnsub = null;
    function startLeadersLive(){
      if (leadersUnsub) return; // Ù…ÙÙØ¹Ù‘Ù„ Ø¨Ø§Ù„ÙØ¹Ù„
      const q = db.collection('users').orderBy('points','desc').limit(10);
      leadersUnsub = q.onSnapshot((snap)=>{
        leadersEl.innerHTML='';
        let rank=1;
        snap.forEach((doc)=>{
          const d = doc.data();
          const li = document.createElement('li');
          li.className='leader-item';
          li.innerHTML = `<span>#${rank} â€” ${escapeHtml(d.username||d.email||'Ù„Ø§Ø¹Ø¨')}</span><b>${d.points||0}</b>`;
          leadersEl.appendChild(li);
          rank++;
        });
        lastUpdateEl.textContent = new Date().toLocaleTimeString();
      });

      // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© (Ø¥Ø¶Ø§ÙØ©Ù‹ Ø¥Ù„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„Ø­Ø¸ÙŠ)
      setInterval(()=>{ lastUpdateEl.textContent = new Date().toLocaleTimeString(); }, 60000);
    }
    function stopLeadersLive(){ if (leadersUnsub){ leadersUnsub(); leadersUnsub=null; } }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    /******************** Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ù…Ù†ÙŠØ© ********************/
    // Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØºØ´: 
    // 1) Ø§Ø³ØªØ®Ø¯Ù… Cloud Function awardWin Ù„ØªØ­Ù‚Ù‚ ÙˆÙ…Ù†Ø­ Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.
    // 2) ÙØ¹Ù‘Ù„ Ù‚ÙˆØ§Ø¹Ø¯ Firestore Ø¨Ø­ÙŠØ« Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ¹Ø¯ÙŠÙ„ Ù†Ù‚Ø§Ø·Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©.
    // 3) ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù†ØªØµØ§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Function.

  </script>
</body>
</html>
